<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Server Farm Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .server { margin-bottom: 12px; }
    button { margin-right: 8px; }
    #combined { margin-top: 18px; font-weight: bold; font-size: 1.2em; }
  </style>
</head>
<body>
  <h1>Server Farm Dashboard</h1>
  <div id="servers"></div>

  <div id="combined">All counting connected into one: 0</div>

  <script>
    const servers = [1,2,3];
    const counters = [null, null, null];

    function renderStatuses(statuses) { // oh yeah renderer? oh wait why did i even write this comment.
      const container = document.getElementById('servers');
      container.innerHTML = '';
      statuses.forEach((st, i) => {
        const num = i + 1;
        const div = document.createElement('div');
        div.className = 'server';
        const connText = counters[i] === null ? ' ' : '';
        div.innerHTML = `
          <strong>Server ${num}:</strong> <span id="status-${num}">${st}</span>${connText}
          <button data-action="toggle" data-id="${num}">${st === 'Started' ? 'Shutdown' : 'Start'} Server ${num}</button> // the problem was that mostly shutdown wont work and both refresh i guess?
          <button data-action="restart" data-id="${num}">Restart Server ${num}</button>
        `;
        container.appendChild(div);
      });
    }

    async function updateStatuses() {
      try {
        const res = await fetch('/status');
        const statuses = await res.json();
        renderStatuses(statuses);
      } catch (err) {
        console.error('Status fetch failed', err);
      }
    }

    setInterval(updateStatuses, 1000);
    updateStatuses();

    document.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('button[data-action]');
      if (!btn) return;
      const action = btn.getAttribute('data-action');
      const id = btn.getAttribute('data-id');
      btn.disabled = true;
      try {
        await fetch(`/api/${action}/${id}`, { method: 'POST' });
        setTimeout(updateStatuses, 300);
      } catch (err) {
        console.error('Action failed', err);
      } finally {
        btn.disabled = false;
      }
    });

    function connectEventSource(serverNum) {
      const idx = serverNum - 1;
      const url = `http://127.0.0.1:600${serverNum}/events`;
      try {
        const es = new EventSource(url);
        es.onmessage = (e) => {
          const val = parseInt(e.data, 10);
          counters[idx] = Number.isFinite(val) ? val : 0;
          updateCombined();
        };
        es.onerror = () => {
          counters[idx] = null;
          updateCombined();
          es.close();
          setTimeout(() => connectEventSource(serverNum), 2000);
        };
      } catch (err) {
        console.error('EventSource error for server', serverNum, err);
        counters[idx] = null;
        setTimeout(() => connectEventSource(serverNum), 2000);
      }
    }

    function updateCombined() {
      const sum = counters.reduce((acc, v) => acc + (v === null ? 0 : v), 0);
      document.getElementById('combined').textContent =
        `All counting connected into one: ${sum}`;
    }

    servers.forEach(n => connectEventSource(n));
  </script>
</body>
</html>

